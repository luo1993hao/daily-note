### 演化式架构师
架构师好比城市规划师
- 职责
  - 确保有一组可以指导开发的原则，并且这些原则要与组织的战略相符
  - 这些原则衍生的实践不会给开发人员带来痛苦
  - 了解新技术，知道什么时候做取舍
  - 花时间和团队一起编码
### 如何建模服务
- 好的服务
  - 高内聚
  - 低耦合
- 最好先使用单体服务，等到系统稳定下来之后，再确定把已有的单块系统划分为微服务（边界搞错了，修复代价大）
- 思考组织内的限定上下文时，不应该从共享数据角度考虑，应该从这些上下文提供的功能来考虑
### 集成
- 微服务通信
  - 避免破坏性修改 
  - 保证api的技术无关性
  - 消费者易消费
  - 隐藏内部细节
- 同步与异步
  - 请求/响应
    - rpc
      - 核心想法是隐藏远程调用的复杂性
      - 网络不可靠
      - 不要对远程调用过度抽象，以至于隐藏网络因素
    - rest
      - 并没有提到底层使用什么协议，http契合度高
      - 性能可能会有问题
- 当你需要做一些基于多个服务调用的操作，尝试一下你所选用技术栈的响应式扩展
- 在微服务内部不要违反dry，但在跨服务的情况下可以适当违反dry
### 分解单块系统
- 事务边界
  - 再试一次
    - 最终一致性
  - 终止整个操作
    - 补偿事务
  - 分布式事务
  - 应该怎么办
    - 尽量避免放在不同的地方
    - 显式创建一个概念来表示这个事务。能够容易补偿/监控
- 报告数据库（统计分析）
  - 通过服务调用来获取数据（少数据量可行）
  - 数据导出（数据库集成）
  ![](https://i.loli.net/2020/07/13/2mCkITHAPtvE3Fi.png)
### 部署
- Cd能够检查每次提交是否达到了部署到生产环境的要求。并持续的把这些信息反馈给我们，
- 使用操作系统所支持的构建物可以避免多种技术栈
- 将镜像作为构建物（docker）
- 部署方式
  - 单主机多服务
    - 监控困难
    - 部署复杂
    - 自治性不强
    - 限制部署构建物选择 
  - 应用程序容器
  - 每个主机一个服务
 ### 测试
![](https://i.loli.net/2020/07/14/P9r3CANHVmu7hQy.png)
- 服务测试
  - 对于包含多个服务的系统，一个服务测试只测试其中一个单独的功能
- mock还是打桩
  - mock是更智能的打桩
  - 一般来说打桩次数远大于mock
- 端到端测试
  - 试图确保部署新的服务到生产环境后，变更不会破坏新服务的消费者
  - 包含在测试的服务越多，测试就会越脆弱，当发现脆弱的测试，我们应该尽力解决。否则。异常正常化
  - 难维护（多个服务的话，谁来写这个测试？）
  - 测试时间可能很长
- 为应用于多个服务上的修改使用相同的版本，会让我们很快接受，同事修改和部署多个服务是可以接受的。而这样做就会丢弃微服务的主要优势：独立于其他服务单独部署成一个服务的能力
- 端到端测试只测试最核心场景
- 尽可能使用消费者驱动的契约测试，来替换端到端测试
![](https://i.loli.net/2020/07/14/j2TkUzGvNMs5Z9S.png)
- 
- 平均修复时间胜过平均故障间隔时间
 - 蓝绿部署与金丝雀发布
 - 有时候花费相同的努力让发布变得更好，比添加更多的自动化测试更有益
 ### 安全
- 服务间的身份验证和授权
  - 在边界内允许一切
  - Https基本身份验证
  - http之上的hmac
    - 第三方无法篡改请求，且私钥本身不会泄漏
 ### 康威定律和系统设计
 - 任何组织在设计一套系统时，所交付的设计方案在结构上都与该组织的沟通结构保持一致
   - 团队小，成员更有责任感
### 规模化微服务
- 故障无处不在
  - 即使买最好的工具，最贵的硬件，也无法避免故障。因此，你需要假定故障会发生，如果以这种想法来处理你做的每一件事情，为期故障做好准备，那么就会最初不同的权衡。
- 了解可以容忍多少故障，系统需要多快，取决于系统的用户  
  - 相应时间/延迟
  - 可用性
  - 数据持久性
- 很多情况下，需要做的往往不是技术决策
- 应对故障
  - 超时
  - 断路器
  ![](https://i.loli.net/2020/07/21/J3PtviW8nBdhOMa.png)
  - 舱壁
    - 每个下游建立一个单独的连接池
    - 断路器看作密封一个舱壁的自动机制
  - 隔离
  - 拆分负载
- 考虑10倍容量的增长，但超过100倍容量时就要重写了   
- 数据库扩展
  - 扩展读取
    - 读写分离，缓存
  - 扩展写
    - 分片  
- 缓存
  - 为写使用缓存，后写式缓存，先写入本地缓存，并在之后的某个时刻将缓存写入下游数据源。
  后写式缓存式在缓冲可能的批处理写操作中，进一步性能优化的方法   
  - 对于一些系统来说，使用失效但可用的数据，比完全不可用的要好
  - 隐藏源服务
    - 重构缓存
 - 自动伸缩
   - 预测性伸缩
   - 相应式伸缩
- 服务发现
 - 核心思想：1. 提供机制，让实例注册并告诉所有人，我在这里 2. 提供了一种方法，一旦服务被注册，就可以找到它。
 - 解决方案
   - DNS
   - 动态服务注册
     - zookeeper
     - consul
     - eureka
 ### 总结
- 微服务的原则
 ![](https://i.loli.net/2020/07/21/Zrp4SHI1L2PoiuW.png)              