### 基本概念
#### 队列模型
- 队列模型
  - 每条消息只能被一个消费者消费
- 发布/订阅模型
  - 就是为让一条消息可以被多个消费者消费而生
![](https://i.loli.net/2020/08/25/IbReAQ9BXniDq4P.png)
#### 常见问题
- 如何保证消息不丢失
  - 生产消息
    - 需要处理broker的相应
    - 如果 Broker 返回写入失败等错误消息，需要重试发送。当多次发送失败需要作报警，日志记录等
  - 存储消息
    - 单机情况，消息刷盘后返回相应
    - 集群部署，写入副本后，再给生产者相应
  - 消费消息
    - 消息业务逻辑处理完成之后再给Broker相应
- 如何处理重复消息
  - 生产者
     - 等到broker相应后
  - 消费者
     - 有时无法避免
     - 关键点就是幂等。既然我们不能防止重复消息的产生，那么我们只能在业务上处理重复消息所带来的影响。（版本号）
- 如何保证消息的有序性
  - 全局有序
    - 生产者，消费者。单线程，一个队列。
  - 部分有序
    - 内部划分成我们需要的队列数，把消息通过特定的策略发往固定的队列中，然后每个队列对应一个单线程处理的消费者
- 如何处理消息堆积
  - 队列设置阈值
  - 定位消费慢
    - bug，改bug
    - 消费能力弱，提高消费能力。(insert one -> insert batch)
    - 水平扩容
### RabbitMq
![](https://i.loli.net/2020/08/25/5pHPl2I73KBqm8w.png)
概念说明：

Binding:一个绑定就是基于路由键将交换器和消息队列连接起来的一个路由规则

channel:多路复用链接中的一条独立的双向数据流通道。发布/订阅/接受消息。都是通过信道完成。建立在真实的tcp连接内的虚拟连接。复用tcp连接
- 交换器类型
  - Direct交换器
    - 消息中路由键和binding的绑定键一致
  - Fanout
    - 每个主机都获得
  - Topic
    - 模式匹配