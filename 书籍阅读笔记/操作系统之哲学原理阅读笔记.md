### 基础原理篇
操作系统在计算机运行过程中扮演的角色
-  魔术师
   - 丑陋变美好
   - 没有变为有
   - 少变多
-  管理者
#### 操作系统导论
- 恰当的思维模式
- 人造科学特点
  - 具有相对性（没有对错）
  - 从对人类活动的主观判断力（堆，队列）
  - 依赖与人的主观判断力
  - 符合人的直觉（同步机制与男女谈恋爱）
 自然存在 /神造具有相反的四个特性
- 操作系统是
   - 操作系统是介于计算机和应用软件之间的一个软件系统
   - 让计算机变得好用
   - 掌握计算机上所有事情的软件系统
- 为什么要学操作系统
  - 抽象，缓存，并发，触类旁通
  - 有趣？  
### 进程原理篇
#### 进程
- 人类希望的并发从理想变为了现实
- ![image-20200616112932993](https://i.loli.net/2020/06/19/17TsBKpUPF5ud9f.png)
- 进程与地址空间研究的主要内容是如何让多个进程空间共享一个物理内存。具体来说，就是高效、安全地让 所有进程共享这片物理内存。
- 公平与效率就成了进程管理中永恒的主题
- 进程的缺点（所以发明了线程）
  - 进程只能在一个时间做一个事情
  - 依赖阻塞
- 进程管理的根本手段是进程表
#### 进程调度
- 程序使用cpu的模式
  - 计算密集型
  - Io密集型
  - 平衡
- 算法
  - 先来先服务调度算法
  - 时间片轮转算法（改善短程序的响应时间）
  - 短任务优先算法
  - 优先调度算法
  - 混合调度算法
  - 实时调度算法
     - EDF调度算法（最早截止的任务先做）
- 调度异常之优先级倒挂
#### 进程通信
- 进程对白
  - 管道
  - 记名管道
  - 套接字（双方都创建一个套接字，一个监听，一个连接）
- 进程电报：信号
- 进程拥抱：共享内存
- 信件发送：消息队列
### 线程原理篇
进程自身是串形的，每个进 程有自己的独立空间，协作困难

- ![](https://i.loli.net/2020/06/19/4bteP8s2wMkgEjz.png)

#### 线程

- 线程就是我们为了让一个进程 能够同时干多件事情而发明的“分身术”。
- ![](https://i.loli.net/2020/06/19/8OSbijJ2so6UcKY.png)

- 线程模型实现
  - 内核态线程实现
    - 编程简单
    - 效率低
  - 用户态编程实现
    - 编程困难（自己写执行系统作为调度器）

- 现代操作系统线程模型

  - 用户态的执行系统负 责进程内部线程在非阻塞时的切换;内核态的操作系统负责阻塞线程的切换

    

#### 线程同步

目的就是不管线程之间的执行如何穿插，其运行结果都是正确的

- 锁解决了同步问题，但带来的是循环等待，我们不满意。为了消除循环等待，我们发明了 睡觉与叫醒。但睡觉与叫醒又带来了死锁，因此，我们发明了信号量。 

- 管程：管程的中心思想是运行一个在管程里面睡觉的线程

  - 管程最大的问题是对编译器的依赖。因为我们需要编译器将需要的同步原语加在管程的开始和结尾

    

- 栅栏

#### 死锁

定义：如果有一组线程，每个线程都在等待一个事件的发生，而这个事件只 能由该组线程里面的另一线程发出，则称这组线程发生了死锁  

##### 死锁的应对
  - 顺其自然，不予理睬
    
    - Windows、Linux和其他商业操作系统都没有采取死锁防止措施，这就是为什么你的电脑经常死机的原因
- 先礼后兵:死锁检测与修复（不可行）
  
- 利用矩阵算法检查死锁
  
- 先发制人:死锁的动态避免
- 斩草除根:死锁的静态防止
  - 消除死锁的必要条件
    - 消除资源独占条件
    
    - 消除保持和请求条件
    
    - 消除非抢占条件
    
    - 消除循环等待条件
    
      

用人口控制来作 比喻，就是不控制婴儿的出生;允许生育，但想办法处理出生的婴儿;不准结婚来静态防止生育和可以结婚 但不许生育来进行动态避免。



#### 锁的实现

- 以中断启用与禁止来实现锁（繁忙等待）
- 以测试与设置指令来实现锁（繁忙等待）
- 以非繁忙等待、中断启用与禁止来实现锁
- 以最少繁忙等待、测试与设置来实现锁

### 内存原理篇

#### 基本内存管理

- 目标

  - 地址保护:一个程序不能访问另一个程序地址空间。

  - 地址独立:程序发出的地址应与物理主存地址无关。

    

- 虚拟内存的概念

- 多道编程下内存管理

  - 固定分区

  - 非固定分区

  - 交换

  - 重叠

  -   ![](https://i.loli.net/2020/06/19/bpejhNa6tUqHv5S.png)

- 动态地址翻译的优点
  - 灵活，可以将 程序随便加载到任何地方
  - 它是实施地址保护的“不二法 门”
  - 它使虚拟内存的概念得以实现

- 闲置空间管理
  - 位图表示法（0，1）
  - 链表表示法

#### 页式内存管理

基址与极限的工作原理是将程序发出的虚拟地址加在基址而获得物理地址。如果地址超过指定的极限，则视 为地址出界而禁止访问，否则访问正常进行

- 空间浪费问题

 - ![](https://i.loli.net/2020/06/19/cVrASY6xuFqGdiD.png)

- 交换存在的问题

  - 空间增长效率低下;

  - 空间增长存在天花板限制。

    

- 分页

  - 分页解决交换缺陷

    -  空间碎片化

    - 程序增加有限
  - 核心思想：将虚拟内存空间和物理内存空间皆划 分为大小相同的页面
  - 分页系统的核心是页面的翻译
  - ![](https://i.loli.net/2020/06/19/Uv5onE4JRj8KPF9.png)
  - 缺点：页表很大
    - 解决办法1：多级页表
      -  大部分次级页表会放到磁盘上
      - 多级页表缺点：降低访问速度
    - 解决办法2:反转页表
    
      - 存放的是物理页面到虚拟页面的映射
      -  如果发生缺页中断，就需要从磁盘上将需要的页面调入内存
      -   缺页中断
        - 如果CPU发出的虚拟地址对应 的页面不在物理内存，就将产生一个缺页中断。而缺页中断服务程序负责将需要的虚拟页面找到并加载到内 存。

##### 页面更换算法

 目的：降低随后发生缺页中断的次数或者概率

- 公平算法

  - 随机算法
  - 先来先出(FIFO)算法
  - 第二次机会算法
  - 时钟算法

- 非公平算法

  - 最优算法

  - NRU算法

  - LRU算法

  - 工作集算法

    

#### 段式内存管理

分页系统共享困难，一个进程只能占有一个虚拟地址空间（无法容忍）

分段管理就是将一个程序按照逻辑单元分成多个程序段，每一个段使用自己单独的虚地址空间

- ![](https://i.loli.net/2020/06/22/d81a4XCMj5yb9ru.png)

- ![](https://i.loli.net/2020/06/22/by2evCm7TVD3EO5.png)

### 文件管理篇

#### 磁盘操作

- 结构
  - 多块盘片
    - 磁道
    - 扇面
  - 信号和界面电子系统
  - 任何时候只能有一个磁头处于活动状态
  - ![](https://i.loli.net/2020/06/22/17hscOpfVtdCPFJ.png)
- 几个概念
  - 寻道时间(seek time)指的是把读写磁头移动到所要求的磁道位置所需要的平均时间
  - 旋转延迟时间指的是在磁头到达所要求的磁道位置后，等待所要求的扇面旋转到磁头下方的平均时间
  - 平均访问时间是寻道时间加上旋转延迟。
  - 可持续数据速度则指的是在一段可持续时间内数据可以被访问的速度



- 磁盘调度算法
  - 影响磁盘读写时间的因素：寻道时间（比重最大） 旋转延迟 数据传输时间
  - 先来先服务FCFS(First Come, First Serve)  
  - 短任务优先STF(Shortest Task First) 
  - 短寻道优先SSF(Shortest Seek First)
  - 电梯调度ES(Elevator Scheduling) 
    -  先满足一个方向的所有请求，再满足所有反方向的请求
  - 提前查看电梯调度ESLA(Elevator Scheduling with Look Ahead) 
  - 单向电梯调度OWES(One Way Elevator Scheduling)

#### 文件系统

- 操作系统为磁盘提供的抽象就是:文件及文件系统

- 文件系统的主要特性就是存储大量的信息，多个进程可以同时访问一个文件，进程结束也不会影响文件的持 续存在
- 文件内容组织
  - 关系导向型组织
    - 将数据之间的关系记录在文件里面
  - 非关系导向型组织
    - 数据就是一个数据流， 没有记录，没有关系

#### 文件系统实现
- 两个目标：地址保护，地址独立
- ![](https://i.loli.net/2020/06/22/fmTNzIYjwh1Eprs.png)

- 存放方式
  - 连续空间存放
  - 非连续空间存放
    - 优点可以利用碎片
    - 缺点访问速度慢

- 文件分配表（FAT）：把所有指针从单个数据块抽取出 来，全部放在一起，形成一张表
  - 每个记录为物理磁盘块编号,每个记录存放的是下一个数据块所存放的物理磁盘块编号
  - 缺点占用太大内存，改进办法，索引文件组织
- 索引文件组织
 -  使用索引组织方式时，用户先宣称文件大概有多大，文件系统则按照用户的声明分配一个含有相应数量指针 空间的I-NODE，但是先不分配真正的磁盘空间。在真正需要分配数据磁盘空间时，每分配一个磁盘数据 块，更新I-NODE里面的相应指针
 - 缺点：麻烦，如果文件增长过大，数据迁移麻烦。解决办法：多级索引组织
   - 就是访问数据块所需要的磁盘访问次数增加了：解决办法：非对称多级索引
 #### 文件系统性能
 - 地址保护方式
  - 主动控制:访问控制表
   - 主动控制将保护措施构建在被保护者身上
  - 能力表
   - 另外一种访问控制手段是将控制措施附在用户身上
  - 保护域
    - 保护域就是将访问控制权限一样的文件和对象组织成同一个域 
 - 文件性能
   - 可靠性
     - 持久性
     - 一致性
       - 日志
       - 事务
       - 随影（保持两个数据版本。通过一个指针告诉用户和应 用软件当前使用的是哪一个版本的数据）
   - 速度
 - 备份方式
  - 主动和被动备份:以谁提要求来区分。
  - 在线和离线备份:以是否停止服务区分。 
  - 实时和延时备份:以主备数据时差区分。 
  - 等分和差分备份:以主备数据量差区分。 
  - 增量和差分增量:以备份量和差分标来区分。 
  - 分裂和并列备份:以备份是否减少来区分。 
  - 近程与远程备份:以主备中心距离区分。
### I/o原理篇
### 多核原理篇
- 基本概念
  - 多处理器结构
  - 超线程结构
   - ![](https://i.loli.net/2020/06/23/281ZY4n3aSiM5XG.png)
   - 两个线程都同时需要某一资源时，其中一个要暂时停止，并让出资源，直到这些资源闲置后才能继续。因 此超线程的性能并不等于两个CPU的性能
  - 多核结构
  - 多核超线程结构
    - ![](https://i.loli.net/2020/06/23/HvVjpJtcrO1LamD.png)
- 多核的内存结构
 - UMA(均匀内存访问 (Uniform Memory Ac-cess, UMA))，所有核地址相同，缺点大锅饭
 - NUMA(非均匀内存访问)，灵活，易扩展
 - COMA,全缓存内存访问(Cache Only Memory Access, COMA)
- 多处理器之间的通信
 - 来协调这些CPU之间中断的机制就是高级可编程中断控制器(APIC)
   - ![](https://i.loli.net/2020/06/23/7MIir1xTalm4nbp.png)
- 缓存一致性
  - MESI模型来实现缓存的一致性
    - ![](https://i.loli.net/2020/06/23/KLf6rwt1SaYAiIp.png) 
 #### 多核环境下的进程同步与调度
 - 多核进程同步
  - 所有软件原语操作均构建在硬件原子操作的基础上
  - 总线锁
  - 硬件提供的另外一种同步原语是交换指令，完成在寄存器和内存单元之间的内容置换
  - 目前操作系统还没有为多核环境提供锁操作
- 旋锁
 -   cpu互斥机制
 - 旋锁通常用于保护某个全局的数据结构
 - 旋锁的拥有者是cpu
 - 缺点：不停地发信号到总线上，会造成对内存总线的竞争
- 队列旋锁
- 调度域
 -   调度域指的是一组CPU。而负载平衡 就是在一个调度域里面的CPU之间进行平衡，使得它们执行的进程数
 ### 操作系统设计篇
 - 层次架构
   - ![](https://i.loli.net/2020/06/23/vszYDaf4nbGHr5c.png)
 - 没有对错
   - 没有对错的原理在数据结构里面体现得更为充分
 - 懒人哲学
   - 懒人哲学(见图22-5)的合理性在于提前将事情做完也许是一种浪费
 - 让困于人  
   - 操作系 统会使用各种原语操作保证文件系统的一致性，但这仅限于文件系统的元数据，而不是平面数据(用户数 据
   - 死锁的处理（放任不管）
 - 留有余地
  -   文件系统目录夹的设计:一个目录夹记录里面 通常都有一部分所谓的保留空间(reserved space)
 - 子虚乌有
 - 时空转换
   - 页表的实现，页表分级，部分在内存，部分在磁盘。付出代价就是时间成本
 - 策机分离与权利分离  
   -这种策机分离既保证了所有产品的一致性，又留有足够 的灵活性。
 - 简单为美  
   - 在文件的存储方式上，我们在网型组织、树型组织、记录流、数据块流和字节流的各种选择当中，现 代操作系统选择的都是最简单的字节流
 - 适合为止
   - make everything as simple as possible，but not simpler  